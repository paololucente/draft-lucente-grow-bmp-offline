<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC2119 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC2918 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2918.xml">
<!ENTITY RFC8174 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.8174.xml">
<!ENTITY RFC7854 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.7854.xml">
<!ENTITY RFC6396 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6396.xml">
<!ENTITY I-D.ietf-grow-bmp-tlv SYSTEM "https://bib.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-grow-bmp-tlv.xml">
<!ENTITY I-D.ietf-grow-bmp-rel SYSTEM "https://bib.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-grow-bmp-rel.xml">
<!ENTITY I-D.petrie-grow-mrt-bmp SYSTEM "https://bib.ietf.org/public/rfc/bibxml3/reference.I-D.petrie-grow-mrt-bmp.xml">
<!ENTITY IANA_PS_MSG_TYPE "TBD1">
<!ENTITY IANA_PS_CODE_PEER_TLV "TBD2">
]>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc strict="yes" ?>
<?rfc toc="yes"?>
<?rfc tocdepth="4"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes" ?>
<?rfc compact="yes" ?>
<?rfc subcompact="no" ?>
<rfc category="std" docName="draft-lucente-grow-bmp-offline-02" ipr="trust200902" submissionType="IETF" updates="7854">
  <front>
    <title>
      BMP State Snapshots
    </title>
    <author fullname="Luuk Hendriks" initials="L" surname="Hendriks">
      <organization>NLnet Labs</organization>
      <address>
        <postal>
          <street>Science Park 400</street>
          <city>Amsterdam</city>
          <code>1098 XH</code>
          <country>NL</country>
        </postal>
        <email>luuk@nlnetlabs.nl</email>
      </address>
    </author>
    <author fullname="Paolo Lucente" initials="P" surname="Lucente">
      <organization>NTT</organization>
      <address>
        <postal>
          <street>Veemweg 23</street>
          <city>Barneveld</city>
          <code>3771 MT</code>
          <country>NL</country>
        </postal>
        <email>paolo@ntt.net</email>
      </address>
    </author>
    <author fullname="Camilo Cardona" initials="C" surname="Cardona">
      <organization>NTT</organization>
      <address>
        <postal>
          <street>164-168, Carrer de Numancia</street>
          <city>Barcelona</city>
          <code>08029</code>
          <country>Spain</country>
        </postal>
        <email>camilo@ntt.net</email>
      </address>
    </author>
    <author fullname="Colin Petrie" initials="C" surname="Petrie">
      <organization>NTT</organization>
      <address>
        <postal>
          <street>Veemweg 23</street>
          <city>Barneveld</city>
          <code>3771 MT</code>
          <country>NL</country>
        </postal>
        <email>colin@ntt.net</email>
      </address>
    </author>
    <date year="2025"/>
    <area>General</area>
    <workgroup>Global Routing Operations</workgroup>
    <keyword>BMP</keyword>
    <abstract>
      <t>
        BMP (BGP Monitoring Protocol) is perfectly suited for real-time
        consumption but less ideal in stream processing and off-wire
        historical scenarios. The main issue is that the ability to
        correctly parse BGP Update PDUs, carried in BMP Route Monitoring
        messages, depends on the BGP Capabilities exchanged during the
        establishment of the BGP session between the peers via BGP Open
        PDUs. The BGP Open PDUs, carried in BMP Peer Up Notification
        messages, are exported at the establishment of the BMP session.
        Similar to BGP, BMP sessions are typically long-lived, so the
        crucial information to correctly parse subsequent messages of
        such sessions was possibly sent a relatively long time ago
        (days, weeks, months).
      </t>
      <t>
        In addition to that required session state, the state of monitored RIBs
        is also only exported at the start of the BMP session. Afterwards, only
        deltas to that state are emitted, in forms of BMP Route Monitoring
        messages. In order to construct a complete and correct view of the
        network, one can not rely on those deltas alone. While constructing the
        state purely on deltas might, eventually, get close to the 'actual'
        state of the network, there is no control over how long one is working
        with an incorrect state, nor is there any guaruantee that it ever will
        be correct.
      </t>
      <t>
        This document introduces the concept of Snapshots. It defines a new
        optional BMP message type, called State Snapshot, and a new TLV,
        called Snapshot Id. A Snapshot is similar to the initial
        synchronisation performed upon establishment of the BMP
        session: all BGP session information is exported in
        Peer Up Notification messages, and all RIB contents are
        exported in Route Monitoring messages. All the messages carry the new
        Snapshot Id TLV, containing an ID uniquely identifying the snapshot
        these messages belong to. The messages are preceded by a State
        Snapshot message carrying the same Snapshot Id TLV, as well as
        meta-data describing the Snapshot.
      </t>
    </abstract>
  </front>
  <middle>
    <section title="Introduction" anchor="Introduction">
      <t>
        Correctly parsing BGP Update PDUs included in BMP messages (ie.
        Route Monitoring) does require a stateful approach by keeping
        track of capabilities exchanged in the BGP Open PDUs as reported
        by BMP Peer Up Notification messages.
      </t>
      <t>
        Peer Up Notification messages are sent only during the initial
        synchronisation at the start of the BMP session, or, whenever a BGP
        session is established on the monitored router. The
        necessary information in the BGP Open (and Peer Up Notification)
        messages may thus have been received long before its needed to parse
        incoming BGP Updates in Route Monitoring messages. This inevitable
        stateful approach might be challenging in certain scenarios, such as
        consuming archived BMP messages or deployments where BMP Stations or
        processing nodes not necessarily see the (complete) start of every
        BMP stream.
      </t>
      <t>
        <xref target="I-D.ietf-grow-bmp-tlv">TLV support for BMP Route
        Monitoring and Peer Down Messages</xref> defines a Stateless Parsing
        TLV aimed at including relevant capabilities that have an impact in
        BGP Update message parsing as part of optional informational TLV in
        Route Monitoring messages. While the method is valid, in fact it does
        allow with minor effort to encapsulate BMP in MRT format for offline
        consumption as documented by
        <xref target="I-D.petrie-grow-mrt-bmp">
          Storing BMP messages in MRT Format
        </xref>, it comes with some drawbacks like extra verbosity and increased
        correlation effort at a BMP exporter,
        where resources may be limited.
      </t>
      <t>
      Similar to how the necessary information carried in the BGP Open
      messages is sent from the exporter to the station only in the
      beginning of a BMP session (in forms of Peer Up Notifications), the
      contents of the RIBs is also only sent at the beginning (in forms of
      Route Monitoring messages). In other words, to make correct and complete
      sense of offline BMP data, both current state (RIB contents) and session
      details (BGP Open Capabilities) to parse future state changes are
      required.
    </t>
      <t>
      This document introduces Snapshots, enabling synchronisation of both
      BGP session information and RIB contents anywhere in a BMP session.
      A Snapshot is not one single message, but a collection of messages, all
      containing a Snapshot Id TLV (introduced in this document) carrying the
      same Snapshot Id. The session state and RIB contents are carried in Peer
      Up Notification messages and Route Monitoring messages, respectively,
      exactly like the initial synchronisation upon establishment of a new BMP
      session.
      In addition to the Peer Up Notification and Route Monitoring messages, two
      State Snapshot messages (introduced in this document) are also included in
      a Snapshot: one preceded all the other messages, signalling the start of
      the Snapshot and optionally containing TLVs carrying metadata about the
      Snapshot. And one State Snapshot messages at the very end, signalling the
      end of the Snapshot, again optionally containing TLVs carrying metadata.
      These TLVs are described in <xref target="meta-data-tlvs"/>.
    </t>
    <section title="Exporter vs Station">
    <t>
      The new concepts described in this document are not restricted to
      either the BMP exporter or the BMP station, as all newly introduced pieces
      are in-protocol and do not rely on any specific characteristic of either
      exporter or station.
      However, as the process of emitting a Snapshot can presumably be
      expensive, it is not to be expected that BMP export implementations on
      routers will support the concepts introduced in this document. A BMP
      station on the other hand likely has more resources available, and will
      have received all the necessary information (in terms of session state and
      RIB contents) from the router already. To not burden limited routers
      more than necessary, the authors assume the 'first' BMP station implements
      the concepts described so any stations 'downstream' can leverage the
      Snapshot functionality, while not imposing any additional load on the
      router originally emitting the BMP stream.
    </t>
    <section title="Considerations regarding alternative approaches">
        <t>
          <cref>
            This section is included as a record of discussion, and is to be
            removed/reduced at a later stage.
          </cref>
        </t>
        <t>
          Emitting all contents of a RIB is very similar, if not identical, to
          the process of a Route Refresh <xref target="RFC2918"/>.
          For routers exporting BMP streams, the assumption is that they support
          Route Refresh.
          The authors evaluated if mimicking a Route Refresh could provide
          functionality similar to State Snapshots, but at lower (computational)
          cost. While a full overview of key features/requirements is listed in
          <xref target="tbl-comparison-rr"/>,
            it was concluded that a Route Refresh lacks (too) many of the
            features of a Snapshot. Moreover, it would still be considered too
            expensive to perform on any regular basis on routers.
        </t>
        <table anchor="tbl-comparison-rr">
            <name>
                Overview of feature/requirement comparison between the approach
                described in this document and a approach based on Route Refresh
                messages
            </name>
            <thead>
                <tr>
                    <td></td>
                    <td>State Snapshots</td>
                    <td>Route Refresh</td>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="3">Feature/quality:</td></tr>
                <tr><td>In-protocol</td>              <td>y</td><td>y</td></tr>
                <tr><td>Signal begin/end</td>         <td>y</td><td>y</td></tr>
                <tr><td>RIB contents</td>             <td>y</td><td>y</td></tr>
                <tr><td>Session info</td>             <td>y</td><td>n</td></tr>
                <tr><td>Distinguish sync vs live</td> <td>y</td><td>n</td></tr>
                <tr><td>Distinguish between syncs</td><td>y</td><td>n</td></tr>
                <tr><td>Per address family</td>       <td>y</td><td>y</td></tr>
                <tr><td>Additional metadata</td>      <td>y</td><td>n</td></tr>
                <tr><td>Extensible</td>               <td>y</td><td>n</td></tr>
                <tr><td>Expensive</td>                <td>y</td><td>Less</td></tr>

                <tr><td colspan="3">Protocol requirement:</td></tr>
                <tr><td>New mesage type or TLV</td>   <td>both</td><td>either</td></tr>
        </tbody>
        </table>
    </section>
  </section>
  <section title="Flexibility and extensibility">
    <t>
      By building upon TLVs,
      supported in all BMP message types from BMPv4, the Snapshot approach
      imposes minimal requirements over the initial synchronisation in BMP
      today. Furthermore, if at any point in the future another message
      type needs to be incorporated in a Snapshot, it will be a simple
      matter of attaching the Snapshot Id TLV to those messages. No
      existing message types have to be adapted to support Snapshots.
    </t>
  </section>
  <section title="Backwards (in)compatibility">
    <t>
      If an implementation lacking support for Snapshots receives a Snapshot, it
      should ignore the State Snapshot messages and the Snapshot Id TLVs, as
      these are all optional. However, this reduces a Snapshot to a bunch of
      Peer Up Notification and Route Monitoring messages indistinguishable from
      'normal' Peer Up Notification and Route Monitoring messages. This
      introduces the following problems:
      <list style="symbols">
        <t>
          Peer Up Notifications from a Snapshot will be interpreted as normal
          Peer Up Notifications, though for a peer that was already considered
          'up'. This situation is not explicitly described in
          <xref target="RFC7854" section="3.3"/>,
          and can be considered unexpected.
          Even though application of Peer Up Notifications could be considered
          idempotent (the state after processing the message is 'this peer is
          up' regardless of how often that message is received and processed),
          receiving the message implicitly signals the peer was down
          before, which is incorrect, and is possibly a source of confusion.
        </t>
        <t>
          Route Monitoring messages from a Snapshot interpreted as normal Route
          Monitoring messages would not come as unexpected in the life cycle of
          a BMP session. Similarly to Peer Up Notification messages, their
          application is idempotent in nature as the result of processing the
          message is 'this route is reachable'. Note that Route Monitoring
          messages from a Snapshot will always be announcements, not
          withdrawals. However, as with Peer Up Notification messages, a normal
          Route Monitoring message implicitly signals 'this route was not
          reachable before', which is incorrect in the case of Route Monitoring
          messages that were actually part of a Snapshot.
        </t>
      </list>
    </t>

    <section title="Possible workaround">
      <t>
        <list style="symbols">
          <t>
            Partial support on the consuming side: dropping messages based on
            Snapshot Id TLV presence
            <t>
              If a station implementation does not support State Snapshots, it
              should be able to recognize Snapshot Id TLVs relatively easily.
              With BMPv4, the BGP Update is carried in a TLV in the Route
              Monitoring message, so any implementation will be able to process
              TLVs to a certain extent. It then only needs to be aware of the
              type code of the Snapshot Id TLV type: as all messages in a
              Snapshot will carry a TLV of this type, the implementation can
              simply skip/drop those messages, and preclude any of the problems
              described above.
            </t>
            <t>
            </t>
          </t>
          <t>
            In-protocol: Introducing a flag in the Per Peer Header
            <t>
              Setting a flag for messages that are part of a Snapshot will allow
              consumers to distinguish between such messages and 'normal' Peer
              Up Notification and Route Monitoring messages. An additional
              benefit of a flag would be the enabling of optimisations on
              the receiving end, where messages pertaining to a Snapshot can now
              easily be treated differently (specific queue or thread) or
              discarded in case the receiver has not interest in Snapshots.
            </t>
            <t>
              Note that this approach also requires (minimal) changes to the
              receiving side, namely the recognition of such a flag.
            </t>
          </t>
        </list>
      </t>
    </section>
  </section>

    </section>
    <section title="Terminology">
      <t>
        The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
        "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and
        "OPTIONAL" in this document are to be interpreted as
        described in BCP 14
        <xref target="RFC2119">RFC 2119</xref>
        <xref target="RFC8174">RFC 8174</xref>
        when, and only when, they
        appear in all capitals, as shown here.
      </t>
      <section title="Terms in this document">
        <dl>
          <dt>Exporter:</dt>
          <dd>
            <t>
              The sender of BMP messages over the TCP session. This could be a
              router, or a BMP Station sending BMP messages onwards.
            </t>
          </dd>
          <dt>Station:</dt>
          <dd>
            <t>
              The receiver of BMP messages. Colloquially also often called the
              'collector'. A Station receives BMP messages from an Exporter. If
              a Station sends out BMP messages, it is considered an Exporter for
              those egress connections.
            </t>
          </dd>
          <dt>Snapshot:</dt>
          <dd>
            <t>
              The logical concept of a collection of Peer Up Notification
              messages and Route Monitoring messages, preceded and followed by a
              Snapshot Message. A Snapshot is not a single message/PDU itself.
            </t>
          </dd>
          <dt>Snapshot Message:</dt>
          <dd>
            <t>
              A BMP message type, introduced in this document, to signal the
              start or end of a Snapshot. The first and last message of a
              Snapshot are of this message type.
            </t>
          </dd>
          <dt>Snapshot message</dt>
          <dd>
            <t>
              A BMP message that is part of a Snapshot, but not of type Snapshot
              Message. For example, a Route Monitoring message that is part of a
              Snapshot is considered a Snapshot message.
            </t>
          </dd>
        </dl>
      </section>
    </section>
    <section title="State Snapshot message" anchor="state-snapshot-message">
      <t>
      Every Snapshot contains exactly two messages of the Snapshot type: one
      preceding all the Peer Up Notifications and Route Monitoring messages
      containing the actual data, and one Snapshot message to signal the end.
      Both follow the same wireformat.
      </t>

      <section title="Wireformat">
        <t>
          The State Snapshot message starts with a BMP Common Header as
            defined in <xref target="RFC7854">Section 4.1 of</xref>.
            The Common Header is directly followed by TLVs. The
            Snapshot Id TLV defined in <xref target="snapshot-id-tlv"/> MUST be
            present and SHOULD be the first of the TLVs. All additional TLVs
            listed in <xref target="meta-data-tlvs"/> are optional.

            <figure anchor="snapshot-message" align="center">
              <name>
                The State Snapshot message wireformat, including the BMP Common
                Header and the Snapshot Id TLV.
              </name>
              <artwork align="center">
<![CDATA[      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+
     |   Version=4   |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                        Message Length >= 6 + 6 + 16           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     | Msg Type=TBD1 |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |        TLV Type = TBD2        |         Length = 16           |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |        Index = 0x0000         |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                                                               |
     |                    Snapshot Id (16 octets)                    |
     |                                                               |
     |                                                               |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
              ]]>
              </artwork>
            </figure>
          </t>
          <t>
            The State Snapshot message can be generated by a BMP exporter or
            by a BMP station, as long as all required data for the
            Peer Up Notification and Route Monitoring messages pertaining to
            the Snapshot are available. The State Snapshot message MUST be
            followed by those messages, with the Snapshot Id TLV attached to every
            message.
          </t>
        </section>
      <section title="Start-of-snapshot">
        <t>
          The Snapshot message preceding all other messages in the Snapshot
          should contain TLVs providing useful metadata for the consumer of the
          Snapshot. For example, the timestamp of snapshot generation, and
          information about the exporter (IP address, software version).
          Furthermore, they can describe which address families are included
          in the snapshot, and for which RIB views (e.g. Adj-RIB-In Pre-policy).
          Note that, as all meta-data TLVs are optional, a consumer of Snapshots
          should never rely on presence of any of these TLVs.
        </t>
      </section>
      <section title="End-of-snapshot">
        <t>
          After all Peer Up Notification and Route Monitoring messages of the
          Snapshot, the end of the Snapshot is signalled by means of another
          Snapshot message. This Snapshot message contains the Snapshot Id TLV
          like all other messages comprising the Snapshot. This Snapshot message
          can also contain meta-data TLVs, most notably the Snapshot Error TLV.
          If, for whatever reason, the sending side can not complete the
          Snapshot, it MUST send a Snapshot message containing a Snapshot Error
          TLVs to signal the Snapshot is incomplete and/or incorrect. For
          discussion on operational consequences, see
          <xref target="snapshot-error"/>.

        </t>
      </section>
    </section>
    <section title="Snapshot Information TLVs">
      <section title="Snapshot Id TLV" anchor="snapshot-id-tlv">
        <t>
          The Snapshot Id TLV is the only mandatory TLV of a State
          Snapshot message as defined in
          <xref target="state-snapshot-message"/>.
          It is an indexed TLV (as it will be included in Route Monitoring
          messages, with index zero), structured as defined
          in
          <xref target="I-D.ietf-grow-bmp-tlv" section="4"/>,
          with a fixed value length of 16 bytes. This allows the
          use of UUID identifiers, or provides sufficient space
          for alternative schemes. Different approaches for schemes
          are discussed in
          <xref target="opcon"/>.
        </t>
      </section>
      <section title="Snapshot Error TLV">
        <t>
          The Snapshot Error TLV is used to signal that a sender can not
          complete a currently in-flight Snapshot, and MUST be included in the
          End-of-snapshot Snapshot message the sender sends to signal the end of
          the (in this case incorrect/incomplete) Snapshot. Sending out the
          End-of-snapshot Snapshot message is crucial, as failing to do so
          leaves the consuming end in a state where it expects more messages
          pertaining to the Snapshot.

          The value in a Snapshot Error TLV is a UTF-8 string of arbitrary
          length, describing the failure reason.
          Note that the Snapshot Error TLV is useful for live connections, but
          less so for offline data on persistent storage: as it's clear the
          Snapshot is incorrect or incomplete, one would likely want to replace
          it with a valid Snapshot instead of archiving the incorrect one. 
        </t>
      </section>
      <section title="Optional meta-data TLVs" anchor="meta-data-tlvs">
        <t>
          The Snapshot message SHOULD carry TLVs providing additional
          information on the BMP session being summarized. These Snapshot
          Information TLVs describe the BMP exporter and station involved,
          and the date and time the snapshot was generated. By embedding
          these TLVs in the offline file, a consumer of the file does not
          have to rely on the filename or other external data to get these
          types of information. All TLVs are non-indexed.
          <list style="symbols"><t>
            Type = TBD3: Datetime of snapshot
              <list style="empty"><t>
                Length: 8 bytes
                  </t><t>
                  Value: 64bit UNIX epoch, in seconds
              </t></list>
              </t><t>
              Type = TBD4: Exporter IP address
              <list style="empty"><t>
                Length: 16 bytes
                  </t><t>
                  Value: IPv6 or IPv4-mapped IPv6 address
              </t></list>
              </t><t>
              Type = TBD5: Exporter sysName
              <list style="empty"><t>
                Length: variable, non-zero, describing the number of bytes
                  </t><t>
                  Value: UTF-8 string
              </t></list>
              </t><t>
              Type = TBD6: Exporter sysDesc
              <list style="empty"><t>
                Length: variable, non-zero, describing the number of bytes
                  </t><t>
                  Value: UTF-8 string
              </t></list>
              </t><t>
              Type = TBD7: Station IP address
              <list style="empty"><t>
                Length: variable, non-zero, describing the number of bytes
                  </t><t>
                  Value: IPv6 or IPv4-mapped IPv6 address
              </t></list>
              </t><t>
              Type = TBD8: Station sysName
              <list style="empty"><t>
                Length: variable, non-zero, describing the number of bytes
                  </t><t>
                  Value: UTF-8 string
              </t></list>
              </t><t>
              Type = TBD9: Station sysDesc
              <list style="empty"><t>
                Length: variable, non-zero, describing the number of bytes
                  </t><t>
                  Value: UTF-8 string
              </t></list>
          </t></list>
        </t>
      </section>
    </section>
    <section title="Third party off-wire encoding formats">
      <t>
        While this document does define a way to facilitate stream processing,
        replay and, more in general, consumption of raw BMP data offline,
        similar benefits may be harnessed by third party off-wire formats in
        replay and, more in general, consumption of raw BMP data offline,
        similar benefits may be harnessed by third party off-wire formats in
        which BMP can be encapsulated into, for example MRT (Multi-Threaded
        Routing Toolkit) as defined by
        <xref target="RFC6396">RFC 6396</xref>.
        As a result of that, this document does not recommend a preferred way
        to stream process or store BMP data offline.
      </t>
    </section>
    <section title="Operational Considerations" anchor="opcon">
      <section title="End-of-snapshot with an Error TLV" anchor="snapshot-error">
        <t>
        </t>
      </section>
      <section title="Snapshot Id scheme ">
        <t>
          The generation and form of the Snapshot Ids introduced in this
          document is left to implementations. This document does not
          enforce any specific approach, though at least the following
          points should be considered. Note that implementations are not
          limited to supporting only one Id scheme, but ideally support
          multiple schemes via local configuration.
        </t>
        <section title="Global uniqueness">
          <t>
            In deployments where information is received from multiple
            BMP vantage points, unique Snapshot Ids might prove handy or
            even crucial in order to distinguish Snapshot A originally
            sent by BMP exporter X, from Snapshot B sent by exporter Y.
            If all exporting processes rely on an algorithm producing
            globally unique identifiers, e.g. UUID version 4, they all
            can send out Snapshots without possibly using an identical
            Snapshot Id generated by another exporter.
          </t>
        </section>
        <section title="Increasing identifiers">
          <t>
            Generating (linearly) increasing identifiers enable the BMP
            station to order Snapshots, and, to spot any missing
            Snapshots. Furthermore, in a (long running) BMP session where
            the exporter generates Snapshots, the Snapshot Id doubles as
            a counter signalling how many Snapshots have been sent so
            far. Note that some of these can be deduced via
            other means: ordering of Snapshots can be done based
            on the Timestamp TLV (TBD3), and the number of sent
            Snapshots could be included in the Stats Report
            message (<xref target="RFC7854" section="4.8"/>).
          </t>
        </section>
      </section>
      <section title="Requesting/triggering snapshots">
        <t>
          BMP being a unidirectional protocol from exporter to station means there
          is no way for a station to request or trigger the creation of a
          Snapshot in-protocol. This document does not define or advocate for any
          specific out-of-band way to do such triggering. But as any
          implementation of Snapshots requires at least one way to trigger their
          creation, some possible approaches are briefly discussed.
        </t>
        <section title="Timer-based">
          <t>
            An exporter could be configured to generate and emit Snapshots on a
            regular interval, without a request from the station. Depending on
            the timing parameters and the size of the Snapshots (i.e, the
            amount of sessions and routes), this might cause high loads on
            either or both sides of the BMP session. This approach should only
            be considered if the station needs a full view on a regular basis,
            which is not necessary in typical deployments.
          </t>
          <t>
            A timer-based approach could be a suitable approach for a station
            generating Snapshots and writing them to persistent storage, e.g.
            doing time-binned historical archiving.
          </t>
        </section>
        <section title="Manual triggers">
          <t>
            In situations where a Snapshot is only used to recover from a broken
            state at a station (either directly connected to the exporter or a
            station further downstream), a dedicated command on the exporter to
            generate and emit a Snapshot could be used. 
          </t>
          <t>
            Note that, for most situations where the station is directly
            connected to the exporter, a re-establishing the TCP connection for
            the BMP stream might be a simpler and perhaps even cheaper
            alternative.
          </t>
        </section>
        <section title="Out-of-band request via other protocols">
          <t>
            For more complex setups where e.g. the BMP messages continue on
            a messages bus, the generation and sending of Snapshots could be
            requested via that message bus or another protocol/API. Such
            requests could include parameters to ask for a Snapshot containing
            only a subset of all the data, e.g. only a certain address family,
            or only a certain RIB view.
            The concept of Snapshots as described in this document allows
            for such subsets, but such an out-of-band protocol and its
            parameters are out of scope.
          </t>
        </section>
      </section>
    </section>
    <section title="Discussion">
      <section title="No EoRs in Snapshots">
        <t>
          This document describes the logical concept of a Snapshot as a
          collection of Peer Up Notifications and Route Monitoring messages,
          preceded and followed by a Snapshot Message. Comparing this to the
          initial synchronisation at the start of a BMP session, there is a
          discrepancy, as the Snapshot does not include EoRs to signal a RIB
          (view) has been fully sent. An EoR in this context is a
          RouteMonitoring message for a certain RIB view (e.g. Adj-RIB-In
          Post-policy, as defined by the flags in the Per Peer Header),
          containing a BGP Update for a certain address family with no
          announcements and no withdrawals.
        </t>
        <t>
          With the Snapshot Message signalling end-of-snapshot, the EoRs are not
          a necessity. One reason for inclusion would be consistency, though the
          current state of EoRs seems to be inconsistent between
          implementations, and the text describing them leaves room for
          interpretation. Including EoRs in a Snapshot perhaps only
          adds to the confusion, and therefore leaving them out could be
          preferable.
        </t>
      </section>
    </section>
    <section title="Security Considerations">
      <t>
        It is not believed that this document adds any additional security
        considerations.
      </t>
    </section>
    <section title="IANA Considerations">
      <t>
        IANA is asked to allocate a new Snapshot message type in the BMP
        Message Types registry with value &IANA_PS_MSG_TYPE;. IANA is also asked
        to to create a registry within the BMP group, named "BMP Snapshot
        Message TLVs".
      </t>
      <t>
        Registration procedures for this registry are:
      </t>
      <texttable>
        <ttcol align="center">
      Range
    </ttcol>
        <ttcol align="center">
      Registration Procedures
    </ttcol>
        <c>0-32767</c>
        <c>Standards Action</c>
        <c>32768-65530</c>
        <c>First Come, First Served</c>
        <c>65531-65534</c>
        <c>Experimental</c>
        <c>65535</c>
        <c>Reserved</c>
      </texttable>
      <t>
        Initial values for this registry are:
      </t>
      <texttable>
        <ttcol align="center">
      Type
    </ttcol>
        <ttcol align="center">
      Description
    </ttcol>
        <ttcol align="center">
      Reference
    </ttcol>
        <c>&IANA_PS_CODE_PEER_TLV;</c>
        <c>Peer</c>
        <c>this document</c>
      </texttable>
    </section>
  </middle>
  <back>
    <references title="Normative References">
    &RFC2119; &RFC8174;
    <?rfc include="reference.RFC.7854.xml"?>
    <?rfc include="reference.RFC.6396.xml"?>

      &I-D.ietf-grow-bmp-tlv;
      &I-D.ietf-grow-bmp-rel; &I-D.petrie-grow-mrt-bmp;
    </references>
    <references title="Informative References">
    &RFC2918;
    </references>
    <section anchor="Acknowledgements" title="Acknowledgements" numbered="no">
      <t>
        TBD
      </t>
    </section>
  </back>
</rfc>
